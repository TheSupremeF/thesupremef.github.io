<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>EPP 4NM - Interaktif Vaziyet Planı V1</title>

  <!-- Material Symbols Outlined (MD3 ikon seti) -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    body { display: flex; flex-direction: column; }

    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      font-size: 18px;
      line-height: 1;
    }

    header {
      padding: 8px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header img.logo {
      height: 28px;
      width: auto;
    }
    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }
    .last-export {
      font-size: 11px;
      padding: 2px 8px;
    }
    .project-name {
      max-width: 260px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #4b5563;
      overflow: hidden;
    }
    .mode-toggle button {
      border: none;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: #9ca3af;
    }
    .mode-toggle button.active {
      background: #4b5563;
      color: #f9fafb;
    }
    header .spacer { flex: 1; }

    .icon-top-button {
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 8px;
    }
    .icon-top-button:hover {
      background: #111827;
    }

    main {
      flex: 1;
      display: flex;
      min-height: 0;
      position: relative;
    }

    .canvas-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #1f2937;
      min-width: 0;
      position: relative;
    }

    .toolbar {
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 20;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(2, 6, 23, 0.95);
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 12px;
      flex-wrap: nowrap;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
    }
    .toolbar label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .toolbar select {
      background: #020617;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      border-radius: 999px;
      font-size: 11px;
      padding: 2px 6px;
    }

    .toolbar button {
      background: #111827;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .toolbar button:hover { background: #1f2937; }
    .toolbar button.toggle-active {
      background: #1f2937;
      border-color: #eab308;
      color: #facc15;
    }

    .toolbar .icon-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
      position: relative;
    }
    .toolbar .icon-button:hover {
      background: #1f2937;
    }
    .toolbar .icon-button input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .canvas-wrapper {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #020617;
    }

    #viewport {
      position: absolute;
      top: 0; left: 0;
      transform-origin: 0 0;
    }

    #mainImage {
      display: block;
      max-width: 100%;
      height: auto;
      user-select: none;
      pointer-events: none;
    }

    #hotspotLayer {
      position: absolute;
      top: 0; left: 0;
      right: 0; bottom: 0;
      pointer-events: none;
    }

    .hotspot {
      position: absolute;
      border: 1px solid rgba(96, 165, 250, 0.9);
      background: rgba(37, 99, 235, 0.18);
      pointer-events: auto;
      cursor: move;
      transition: box-shadow 0.1s ease-out;
      border-style: solid;
    }
    .hotspot.selected {
      border-width: 2px;
      border-color: #facc15;
    }
    .hotspot.glow:hover {
      box-shadow: 0 0 0 2px rgba(250, 250, 250, 0.85);
    }
    .hotspot-label {
      position: absolute;
      top: -16px;
      left: 0;
      font-size: 11px;
      background: #020617;
      padding: 1px 4px;
      border-radius: 3px;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      white-space: nowrap;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .handle {
      position: absolute;
      width: 8px; height: 8px;
      border-radius: 2px;
      background: #f97316;
      border: 1px solid #111827;
      cursor: nwse-resize;
    }
    .handle.nw { top: -4px; left: -4px; cursor: nwse-resize; }
    .handle.ne { top: -4px; right: -4px; cursor: nesw-resize; }
    .handle.sw { bottom: -4px; left: -4px; cursor: nesw-resize; }
    .handle.se { bottom: -4px; right: -4px; cursor: nwse-resize; }

    /* Sağ panel overlay */
    aside {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 360px;
      max-width: 42%;
      background: #020617;
      display: flex;
      flex-direction: column;
      box-shadow: -16px 0 40px rgba(0,0,0,0.6);
      border-left: 1px solid #1f2937;
      z-index: 30;
    }
    aside header {
      background: #020617;
      border-bottom: 1px solid #1f2937;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
    }
    .side-body {
      padding: 8px 12px;
      font-size: 13px;
      overflow-y: auto;
    }
    .side-section {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #111827;
    }
    .side-section:last-child { border-bottom: none; margin-bottom: 0; }
    .side-section h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
    }
    .side-section label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .side-section input[type="text"],
    .side-section textarea,
    .side-section input[type="color"],
    .side-section input[type="range"],
    .side-section select,
    .side-section input[type="number"] {
      width: 100%;
      border-radius: 4px;
      border: 1px solid #374151;
      padding: 4px 6px;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .side-section input[type="color"] {
      padding: 0;
      height: 28px;
    }
    .side-section textarea {
      min-height: 60px;
      resize: vertical;
    }
    .side-section button {
      background: #111827;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 4px;
      margin-top: 4px;
    }
    .side-section button.danger {
      border-color: #b91c1c;
      color: #fecaca;
      background: #111827;
    }
    .side-section button:hover { background: #1f2937; }

    /* Status pill yapısı */
    .status-pill {
      display: inline-flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      margin-bottom: 4px;
      margin-right: 4px;
      background: #020617;
    }
    .status-pill .indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      padding-top: 2px;
    }
    .status-pill .info-wrapper {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .status-pill .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }
    .status-pill .top-row span {
      white-space: nowrap;
    }
    .status-pill .separator {
      opacity: 0.6;
    }
    .status-pill .bottom-row {
      font-size: 11px;
      color: #d1d5db;
    }
    .status-pill.green { border-color: #16a34a; color: #bbf7d0; }
    .status-pill.yellow { border-color: #eab308; color: #fef9c3; }
    .status-pill.red { border-color: #dc2626; color: #fecaca; }

    .hotspot-list-item {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid transparent;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .hotspot-list-item:hover {
      background: #020617;
      border-color: #1f2937;
    }
    .hotspot-list-item.active {
      background: #111827;
      border-color: #4b5563;
    }

    .thumb {
      width: 100%;
      border-radius: 4px;
      border: 1px solid #111827;
      margin-bottom: 4px;
      max-height: 200px;
      object-fit: contain;
      background: #020617;
      cursor: pointer;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .inline-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .inline-row span {
      font-size: 11px;
      color: #9ca3af;
    }

    .works-row {
      margin-bottom: 6px;
    }
    .works-row-title {
      font-size: 12px;
      color: #e5e7eb;
      margin-bottom: 2px;
    }
    .works-row-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .works-row-controls select {
      flex: 1 0 130px;
    }
    .works-row-controls input[type="number"] {
      width: 70px;
    }
    .works-row-controls span {
      font-size: 11px;
      color: #9ca3af;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-dialog {
      background: #020617;
      border-radius: 12px;
      padding: 16px 20px;
      border: 1px solid #1f2937;
      max-width: 360px;
      width: calc(100% - 40px);
      box-shadow: 0 24px 60px rgba(0,0,0,0.7);
    }
    .modal-dialog h2 {
      font-size: 14px;
      margin: 0 0 8px 0;
    }
    .modal-dialog p {
      font-size: 13px;
      margin: 0 0 4px 0;
    }
    .modal-dialog input[type="text"],
    .modal-dialog input[type="password"],
    .modal-dialog textarea,
    .modal-dialog select {
      width: 100%;
      border-radius: 4px;
      border: 1px solid #374151;
      padding: 4px 6px;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      margin-top: 4px;
    }
    .modal-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .modal-actions button {
      background: #111827;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
    }
    .modal-actions button:hover { background: #1f2937; }

    .about-logo {
      display: block;
      max-width: 100%;
      max-height: 160px;
      margin: 8px auto 0 auto;
      object-fit: contain;
    }

    #detailImageDialog {
      max-width: 80vw;
    }
    #detailImageDialog img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 8px;
      border: 1px solid #111827;
      display: block;
      margin: 0 auto;
      background: #020617;
    }

    /* PIN giriş kutuları */
    .pin-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 12px 0 4px;
    }
    .pin-box {
      width: 40px;
      height: 40px;
      text-align: center;
      font-size: 20px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }
    .pin-box:focus {
      outline: none;
      border-color: #eab308;
      box-shadow: 0 0 0 1px #eab308;
    }

    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      .canvas-column {
        border-right: none;
        border-bottom: 1px solid #1f2937;
        height: 55vh;
      }
      aside {
        left: 0;
        right: 0;
        top: auto;
        bottom: 0;
        width: 100%;
        max-width: none;
        height: 45vh;
        box-shadow: 0 -16px 40px rgba(0,0,0,0.6);
        border-left: none;
        border-top: 1px solid #1f2937;
      }
      .toolbar {
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" class="logo" />
    <span class="chip">İnteraktif Vaziyet Planı</span>

    <span id="lastExportLabel" class="chip last-export">Son kayıt: -</span>
    <span id="projectNameLabel" class="chip" style="display:none;"></span>

    <div class="spacer"></div>

    <button id="projectInfoBtn"
            class="icon-top-button"
            title="Proje bilgileri"
            style="display:none">
      <span class="material-symbols-outlined">info</span>
    </button>

    <button id="passwordSettingsBtn"
            class="icon-top-button"
            title="Düzenleme PIN'i"
            style="display:none">
      <span class="material-symbols-outlined">vpn_key</span>
    </button>

    <div class="mode-toggle" id="modeToggle">
      <button data-mode="viewer" class="active">Görüntüle</button>
      <button data-mode="editor">Düzenle</button>
    </div>

    <button id="aboutBtn" class="icon-top-button" title="Hakkında">
      <span class="material-symbols-outlined">info</span>
    </button>
  </header>

  <main>
    <div class="canvas-column">
      <div class="toolbar">
        <label
          id="mainImageWrapper"
          class="icon-button"
          title="Ana görsel yükle (yalnızca düzenleme modunda)"
          style="display:none">
          <span class="material-symbols-outlined">image</span>
          <input type="file" id="mainImageInput" accept="image/*">
        </label>

        <label title="İmalat görünümü">
          <select id="workViewSelect"></select>
        </label>

        <button id="resetViewBtn" title="Görünümü sıfırla">
          <span class="material-symbols-outlined">restart_alt</span>
        </button>
        <button id="panModeBtn" title="Pan modunu aç/kapat">
          <span class="material-symbols-outlined">pan_tool_alt</span>
        </button>
        <button id="labelsBtn" title="Hotspot etiketlerini göster/gizle">
          <span class="material-symbols-outlined">label</span>
        </button>
        <button id="addHotspotBtn" title="Yeni hotspot oluştur" style="display:none">
          <span class="material-symbols-outlined">add_box</span>
        </button>
        <button id="exportBtn" title="Kaydet">
          <span class="material-symbols-outlined">download</span>
        </button>
        <button id="importBtn" title="Aç">
          <span class="material-symbols-outlined">upload</span>
        </button>
        <button id="summaryBtn" title="İmalat türlerine göre toplam kişi sayıları">
          <span class="material-symbols-outlined">summarize</span>
        </button>

        <input type="file" id="importInput" accept=".epp,.zip,application/zip" style="display:none">
      </div>

      <div class="canvas-wrapper" id="canvasWrapper">
        <div id="viewport">
          <img id="mainImage" alt="Vaziyet planı">
          <div id="hotspotLayer"></div>
        </div>
      </div>
    </div>

    <aside>
      <header>Detaylar</header>
      <div class="side-body" id="sideBody"></div>
    </aside>
  </main>

  <!-- Hakkında -->
  <div id="aboutOverlay" class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Hakkında</h2>
      <img src="about-logo.png" alt="Hakkında Logo" class="about-logo">
      <p style="margin-top:8px;font-size:12px;">2025 (C)</p>
      <p class="hint">Kapatmak için pencere dışına tıklayın.</p>
    </div>
  </div>

  <!-- Düzenleme PIN ayarı -->
  <div id="passwordSettingsOverlay" class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Düzenleme PIN'i</h2>
      <p>Bu dosya için 4 haneli bir düzenleme PIN'i belirleyebilirsin. Tüm kutuları boş bırakırsan koruma kaldırılır.</p>
      <div class="pin-row" id="passwordSettingsPin">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
      </div>
      <div class="modal-actions">
        <button id="passwordSettingsCancel">Vazgeç</button>
        <button id="passwordSettingsSave">Kaydet</button>
      </div>
      <p class="hint">Bu PIN EPP içindeki config.json’da düz metin olarak saklanır.</p>
    </div>
  </div>

  <!-- Düzenleme PIN prompt -->
  <div id="passwordPromptOverlay" class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Düzenleme kilitli</h2>
      <p>Düzenleme moduna geçmek için PIN gir.</p>
      <div class="pin-row" id="passwordPromptPin">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
        <input type="password" inputmode="numeric" maxlength="1" class="pin-box" autocomplete="off">
      </div>
      <div class="modal-actions">
        <button id="passwordPromptCancel">İptal</button>
        <button id="passwordPromptOk">Devam</button>
      </div>
      <p class="hint">4 haneli PIN.</p>
    </div>
  </div>

  <!-- Proje bilgileri -->
  <div id="projectInfoOverlay" class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Proje bilgileri</h2>
      <p>Bu EPP dosyasına ait proje adını ve yükleniciyi kaydedebilirsin.</p>
      <label for="projectNameInput">Proje adı</label>
      <input type="text" id="projectNameInput" placeholder="Örn. KAHRAMANMARAŞ DULKADİROĞLU MERKEZ 15 2. ETAP 1. KISIM KONUT VE TİCARET İNŞAATLARI İLE ALTYAPI VE ÇEVRE DÜZENLEME İŞİ">
      <label for="projectContractorInput" style="margin-top:8px;">Yüklenici</label>
      <input type="text" id="projectContractorInput" placeholder="Örn. SUR YAPI Endüstri San. ve Tic. A.Ş.">
      <div class="modal-actions">
        <button id="projectInfoCancel">Vazgeç</button>
        <button id="projectInfoSave">Kaydet</button>
      </div>
      <p class="hint">Bu bilgiler EPP içindeki config.json’da düz metin olarak saklanır.</p>
    </div>
  </div>

  <!-- Detay görseli büyük gösterme -->
  <div id="detailImageOverlay" class="modal-backdrop">
    <div class="modal-dialog" id="detailImageDialog">
      <img id="detailImageLarge" alt="Detay" />
    </div>
  </div>

  <!-- JSZip CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
(function() {
  const WORK_GROUPS = [
    {
      id: 'kaba',
      label: 'KABA İMALATLARI',
      items: [
        { id: 'kazi', label: 'Kazı İmalatları' },
        { id: 'kazik', label: 'Kazık İmalatları' },
        { id: 'grobeton', label: 'Grobeton İmalatları' },
        { id: 'temel_alti_yalitim', label: 'Temel Altı Yalıtım İmalatları' },
        { id: 'temel', label: 'Temel İmalatları' },
        { id: 'tunnel_kalip', label: 'Tünel Kalıp İmalatları' },
        { id: 'balkon_parapet', label: 'Balkon Parapet İmalatları' },
        { id: 'merdiven', label: 'Merdiven İmalatları' },
        { id: 'cati_parapeti_asansor_kulesi', label: 'Çatı Parapeti ve Asansör Kulesi İmalatları' },
        { id: 'cati_koruma_betonu', label: 'Çatı Koruma Betonu İmalatları' },
        { id: 'cati_yalitim', label: 'Çatı Yalıtım İmalatları' }
      ]
    },
    {
      id: 'ic_mekan',
      label: 'İÇ MEKAN İNCE İMALATLARI',
      items: [
        { id: 'duvar', label: 'Duvar İmalatları' },
        { id: 'ic_mekan_kara_siva', label: 'İç Mekan Kara Sıva İmalatları' },
        { id: 'alci_siva', label: 'Alçı Sıva İmalatları' },
        { id: 'sap', label: 'Şap İmalatları' },
        { id: 'mermer', label: 'Mermer İmalatları' },
        { id: 'seramik', label: 'Seramik İmalatları' },
        { id: 'vitrifiye', label: 'Vitrifiye Montajları' }
      ]
    },
    {
      id: 'dis_cephe',
      label: 'DIŞ CEPHE İMALATLARI',
      items: [
        { id: 'iskele', label: 'İskele İmalatları' },
        { id: 'dis_cephe_kara_siva', label: 'Dış Cephe Kara Sıva İmalatları' },
        { id: 'mantolama', label: 'Mantolama İmalatları' },
        { id: 'mineral_siva', label: 'Mineral Sıva İmalatları' },
        { id: 'dograma', label: 'Doğrama Montajları' },
        { id: 'dis_cephe_boya', label: 'Dış Cephe Boya İmalatları' },
        { id: 'bina_giris_dogramalari', label: 'Bina Giriş Doğramaları' },
        { id: 'merdiven_korkuluk', label: 'Merdiven Korkulukları' },
        { id: 'balkon_korkuluk', label: 'Balkon Korkulukları' },
        { id: 'asansor', label: 'Asansör Montajları' }
      ]
    }
  ];

  const ALL_WORK_ITEMS = WORK_GROUPS.flatMap(group => group.items);

  const STATUS_OPTIONS = [
    { value: 'baslamadi', label: 'Başlamadı' },
    { value: 'devam_ediyor', label: 'Devam ediyor' },
    { value: 'tamamlandi', label: 'Tamamlandı' }
  ];

  const state = {
    mode: 'viewer',
    hotspots: [],
    selectedIds: new Set(),
    grid: 1,
    scale: 1,
    offsetX: 0,
    offsetY: 0,
    mainImageUrl: null,
    panMode: false,
    showLabels: true,
    lastExportAt: null,
    showSummary: false,
    highlightWorkTypeId: null,
    editorPassword: '',
    editorUnlocked: true,
    sidePanelVisible: false,
    projectInfo: {
      name: '',
      contractor: ''
    }
  };

  const mainImage = document.getElementById('mainImage');
  const hotspotLayer = document.getElementById('hotspotLayer');
  const canvasWrapper = document.getElementById('canvasWrapper');
  const viewport = document.getElementById('viewport');
  const modeToggle = document.getElementById('modeToggle');
  const sideBody = document.getElementById('sideBody');
  const asideEl = document.querySelector('aside');

  const mainImageWrapper = document.getElementById('mainImageWrapper');
  const mainImageInput = document.getElementById('mainImageInput');
  const resetViewBtn = document.getElementById('resetViewBtn');
  const addHotspotBtn = document.getElementById('addHotspotBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importInput = document.getElementById('importInput');
  const panModeBtn = document.getElementById('panModeBtn');
  const labelsBtn = document.getElementById('labelsBtn');
  const summaryBtn = document.getElementById('summaryBtn');
  const lastExportLabel = document.getElementById('lastExportLabel');
  const workViewSelect = document.getElementById('workViewSelect');
  const aboutBtn = document.getElementById('aboutBtn');
  const aboutOverlay = document.getElementById('aboutOverlay');
  const passwordSettingsBtn = document.getElementById('passwordSettingsBtn');
  const passwordSettingsOverlay = document.getElementById('passwordSettingsOverlay');
  const passwordSettingsPin = document.getElementById('passwordSettingsPin');
  const passwordSettingsSave = document.getElementById('passwordSettingsSave');
  const passwordSettingsCancel = document.getElementById('passwordSettingsCancel');
  const passwordPromptOverlay = document.getElementById('passwordPromptOverlay');
  const passwordPromptPin = document.getElementById('passwordPromptPin');
  const passwordPromptOk = document.getElementById('passwordPromptOk');
  const passwordPromptCancel = document.getElementById('passwordPromptCancel');
  const detailImageOverlay = document.getElementById('detailImageOverlay');
  const detailImageLarge = document.getElementById('detailImageLarge');
  const projectNameLabel = document.getElementById('projectNameLabel');
  const projectInfoBtn = document.getElementById('projectInfoBtn');
  const projectInfoOverlay = document.getElementById('projectInfoOverlay');
  const projectNameInput = document.getElementById('projectNameInput');
  const projectContractorInput = document.getElementById('projectContractorInput');
  const projectInfoCancel = document.getElementById('projectInfoCancel');
  const projectInfoSave = document.getElementById('projectInfoSave');

  function setTransform() {
    viewport.style.transform = `translate(${state.offsetX}px, ${state.offsetY}px) scale(${state.scale})`;
  }

  function snapPercent(val) {
    const g = state.grid || 1;
    return Math.round(val / g) * g;
  }

  function hexToRgba(hex, alpha) {
    if (!hex) return `rgba(37,99,235,${alpha})`;
    let c = hex.replace('#','');
    if (c.length === 3) {
      c = c[0]+c[0]+c[1]+c[1]+c[2]+c[2];
    }
    if (c.length !== 6) return `rgba(37,99,235,${alpha})`;
    const r = parseInt(c.slice(0,2),16);
    const g = parseInt(c.slice(2,4),16);
    const b = parseInt(c.slice(4,6),16);
    if (Number.isNaN(r) || Number.isNaN(g) || Number.isNaN(b)) {
      return `rgba(37,99,235,${alpha})`;
    }
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function createDefaultWorks(existing) {
    const works = {};
    ALL_WORK_ITEMS.forEach(w => {
      const prev = existing && existing[w.id];
      let workersVal = 0;
      if (prev && typeof prev.workers === 'number' && !isNaN(prev.workers)) {
        workersVal = prev.workers;
      }
      const subVal = prev && typeof prev.subcontractor === 'string' ? prev.subcontractor : '';
      works[w.id] = {
        status: prev && prev.status ? prev.status : 'baslamadi',
        workers: workersVal,
        subcontractor: subVal
      };
    });
    return works;
  }

  function createHotspot(initial) {
    const id = 'hs-' + Date.now() + '-' + Math.random().toString(36).slice(2, 7);
    const hs = Object.assign({
      id,
      top: 40,
      left: 40,
      width: 10,
      height: 10,
      ada: '',
      parsel: '',
      blok: '',
      description: '',
      detailImageUrl: null,
      fillColor: '#2563eb',
      fillOpacity: 0,
      borderColor: '#60a5fa',
      borderOpacity: 0,
      hoverGlow: true,
      works: createDefaultWorks()
    }, initial || {});
    if (!hs.works) {
      hs.works = createDefaultWorks();
    } else {
      hs.works = createDefaultWorks(hs.works);
    }
    state.hotspots.push(hs);
    state.selectedIds = new Set([id]);
    state.showSummary = false;
    state.sidePanelVisible = true;
    renderHotspots();
    renderSidePanel();
  }

  function getHotspot(id) {
    return state.hotspots.find(h => h.id === id);
  }

  function statusTextTr(code) {
    const opt = STATUS_OPTIONS.find(o => o.value === code);
    return opt ? opt.label : code;
  }

  function workStatusClass(code) {
    if (code === 'tamamlandi') return 'green';
    if (code === 'devam_ediyor') return 'yellow';
    if (code === 'baslamadi') return 'red';
    return '';
  }

  function workStatusIcon(code) {
    if (code === 'tamamlandi') return '✔';
    if (code === 'devam_ediyor') return '▬';
    if (code === 'baslamadi') return '✖';
    return '•';
  }

  function buildHotspotLabel(hs) {
    const hasParsel = hs.parsel && hs.parsel.trim() !== '';
    const hasAda = hs.ada && hs.ada.trim() !== '';
    const blokText = hs.blok && hs.blok.trim() !== '' ? hs.blok.trim() : hs.id;

    if (hasAda && hasParsel) {
      return `ADA ${hs.ada.trim()} - PARSEL ${hs.parsel.trim()} - ${blokText} BLOK`;
    }
    if (hasAda && !hasParsel) {
      return `ADA ${hs.ada.trim()} - ${blokText} BLOK`;
    }
    return blokText;
  }

  function renderHotspots() {
    hotspotLayer.innerHTML = '';
    if (!state.mainImageUrl) return;

    state.hotspots.forEach(h => {
      const el = document.createElement('div');
      el.className = 'hotspot' + (state.selectedIds.has(h.id) ? ' selected' : '');
      if (h.hoverGlow !== false) {
        el.classList.add('glow');
      }

      let fillColor = h.fillColor || '#2563eb';
      let fillOpacity = typeof h.fillOpacity === 'number' ? h.fillOpacity : 0.2;
      let borderColorHex = h.borderColor || fillColor;
      let borderOpacity = typeof h.borderOpacity === 'number' ? h.borderOpacity : 1;

      if (state.highlightWorkTypeId) {
        const works = h.works || {};
        const workItem = works[state.highlightWorkTypeId];
        const status = workItem ? (workItem.status || 'baslamadi') : 'baslamadi';
        if (status === 'tamamlandi') {
          fillColor = '#22c55e';
        } else if (status === 'devam_ediyor') {
          fillColor = '#eab308';
        } else {
          fillColor = '#ef4444';
        }
        fillOpacity = 0.2;
        borderColorHex = fillColor;
        borderOpacity = 1;
      }

      el.style.top = h.top + '%';
      el.style.left = h.left + '%';
      el.style.width = h.width + '%';
      el.style.height = h.height + '%';
      el.style.backgroundColor = hexToRgba(fillColor, fillOpacity);
      el.style.borderColor = hexToRgba(borderColorHex, borderOpacity);
      el.style.borderStyle = borderOpacity <= 0 ? 'none' : 'solid';
      el.style.cursor = state.mode === 'editor' ? 'move' : 'pointer';

      el.dataset.id = h.id;

      if (state.showLabels) {
        const label = document.createElement('div');
        label.className = 'hotspot-label';
        label.textContent = buildHotspotLabel(h);
        el.appendChild(label);
      }

      if (state.mode === 'editor') {
        ['nw','ne','sw','se'].forEach(pos => {
          const handle = document.createElement('div');
          handle.className = 'handle ' + pos;
          handle.dataset.id = h.id;
          handle.dataset.handle = pos;
          el.appendChild(handle);
        });
      }

      hotspotLayer.appendChild(el);
    });
  }

  function renderSummaryPanel() {
    const sec = document.createElement('div');
    sec.className = 'side-section';
    const h = document.createElement('h3');
    h.textContent = 'Toplam kişi sayıları';
    sec.appendChild(h);

    let any = false;
    let globalTotal = 0;

    WORK_GROUPS.forEach(group => {
      let groupHas = false;
      group.items.forEach(w => {
        let total = 0;
        state.hotspots.forEach(hs => {
          if (!hs.works) return;
          const item = hs.works[w.id];
          if (!item) return;
          const n = typeof item.workers === 'number' ? item.workers : 0;
          if (!isNaN(n)) total += n;
        });
        if (total > 0) {
          if (!groupHas) {
            const gh = document.createElement('p');
            gh.style.fontWeight = '600';
            gh.style.margin = '4px 0 2px 0';
            gh.style.fontSize = '12px';
            gh.textContent = group.label;
            sec.appendChild(gh);
            groupHas = true;
          }
          any = true;
          globalTotal += total;
          const row = document.createElement('p');
          row.textContent = `${w.label}: ${total} kişi`;
          sec.appendChild(row);
        }
      });
    });

    if (!any) {
      const p = document.createElement('p');
      p.className = 'hint';
      p.textContent = 'Herhangi bir imalat türü için kişi sayısı girilmemiş.';
      sec.appendChild(p);
    }

    if (globalTotal > 0) {
      const totalP = document.createElement('p');
      totalP.style.marginTop = '6px';
      totalP.style.fontWeight = '600';
      totalP.textContent = `Genel toplam: ${globalTotal} kişi`;
      sec.appendChild(totalP);
    }

    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = 'Kişi sayıları tüm hotspotlar (bloklar) üzerinden toplanmıştır.';
    sec.appendChild(hint);

    sideBody.appendChild(sec);
  }

  function openDetailImageModal(src) {
    if (!detailImageOverlay || !detailImageLarge) return;
    detailImageLarge.src = src;
    detailImageOverlay.style.display = 'flex';
  }

  function renderSidePanel() {
    if (!asideEl) return;

    if (!state.sidePanelVisible) {
      asideEl.style.display = 'none';
      sideBody.innerHTML = '';
      return;
    }

    asideEl.style.display = 'flex';
    sideBody.innerHTML = '';

    if (state.showSummary) {
      renderSummaryPanel();
      return;
    }

    const ids = Array.from(state.selectedIds);
    const selected = ids.map(getHotspot).filter(Boolean);

    if (state.mode === 'viewer') {
      if (!selected.length) {
        state.sidePanelVisible = false;
        asideEl.style.display = 'none';
        return;
      }
      const sec = document.createElement('div');
      sec.className = 'side-section';
      const h = document.createElement('h3');
      h.textContent = 'Blok detayları';
      sec.appendChild(h);

      const hs = selected[0];
      hs.works = createDefaultWorks(hs.works);

      const title = document.createElement('p');
      title.innerHTML = `<strong>${buildHotspotLabel(hs)}</strong>`;
      sec.appendChild(title);

      const loc = document.createElement('p');
      loc.textContent = `Ada: ${hs.ada || '-'} · Parsel: ${hs.parsel || '-'}`;
      sec.appendChild(loc);

      const worksTitle = document.createElement('h3');
      worksTitle.textContent = 'İmalat durumları';
      sec.appendChild(worksTitle);

      let hasAny = false;

      WORK_GROUPS.forEach(group => {
        let groupHas = false;
        group.items.forEach(w => {
          const item = hs.works[w.id];
          if (!item) return;
          const status = item.status || 'baslamadi';
          const workers = typeof item.workers === 'number' ? item.workers : 0;
          const subcontractor = item.subcontractor || '';
          const hasActivity =
            status !== 'baslamadi' ||
            workers > 0 ||
            (subcontractor && subcontractor.trim() !== '');
          if (!hasActivity) return;

          if (!groupHas) {
            const gh = document.createElement('p');
            gh.style.fontWeight = '600';
            gh.style.fontSize = '12px';
            gh.style.margin = '6px 0 2px 0';
            gh.textContent = group.label;
            sec.appendChild(gh);
            groupHas = true;
          }

          hasAny = true;

          const row = document.createElement('div');
          const cls = workStatusClass(status);
          row.className = 'status-pill ' + cls;

          const statusLabel = statusTextTr(status);
          const itemsTop = [];
          itemsTop.push(w.label);
          itemsTop.push(statusLabel);
          if (workers > 0) {
            itemsTop.push(`${workers} kişi`);
          }

          let topRowHtml = '';
          itemsTop.forEach((txt, idx) => {
            if (idx > 0) {
              topRowHtml += `<span class="separator">·</span>`;
            }
            topRowHtml += `<span>${txt}</span>`;
          });

          const hasSub = subcontractor && subcontractor.trim() !== '';
          const bottomRowHtml = hasSub
            ? `<div class="bottom-row">Alt Yüklenici: ${subcontractor.trim()}</div>`
            : '';

          row.innerHTML =
            `<span class="indicator">${workStatusIcon(status)}</span>` +
            `<div class="info-wrapper">` +
              `<div class="top-row">${topRowHtml}</div>` +
              bottomRowHtml +
            `</div>`;

          sec.appendChild(row);
        });
      });

      if (!hasAny) {
        const p = document.createElement('p');
        p.className = 'hint';
        p.textContent = 'Bu blok için henüz imalat bilgisi girilmemiş.';
        sec.appendChild(p);
      }

      if (hs.detailImageUrl) {
        const img = document.createElement('img');
        img.src = hs.detailImageUrl;
        img.className = 'thumb';
        img.addEventListener('click', () => openDetailImageModal(hs.detailImageUrl));
        sec.appendChild(img);
      }

      if (hs.description) {
        const descLabel = document.createElement('label');
        descLabel.textContent = 'Açıklama';
        sec.appendChild(descLabel);
        const desc = document.createElement('p');
        desc.textContent = hs.description;
        sec.appendChild(desc);
      }

      sideBody.appendChild(sec);
      return;
    }

    const secPlan = document.createElement('div');
    secPlan.className = 'side-section';
    const hPlan = document.createElement('h3');
    hPlan.textContent = 'Plan';
    secPlan.appendChild(hPlan);

    const pInfo = document.createElement('p');
    pInfo.innerHTML = state.mainImageUrl
      ? 'Ana görsel yüklendi.'
      : 'Ana görsel yok. Araç çubuğundaki ana görsel ikonundan yükleyin.';
    secPlan.appendChild(pInfo);

    if (state.projectInfo && (state.projectInfo.name || state.projectInfo.contractor)) {
      if (state.projectInfo.name) {
        const pName = document.createElement('p');
        pName.textContent = state.projectInfo.name;
        secPlan.appendChild(pName);
      }
      if (state.projectInfo.contractor) {
        const pContr = document.createElement('p');
        pContr.textContent = 'Yüklenici: ' + state.projectInfo.contractor;
        secPlan.appendChild(pContr);
      }
    }

    if (state.lastExportAt) {
      const pExp = document.createElement('p');
      pExp.className = 'hint';
      pExp.textContent = 'Son EPP kaydı: ' + formatDateTime(state.lastExportAt);
      secPlan.appendChild(pExp);
    }

    sideBody.appendChild(secPlan);

    const secList = document.createElement('div');
    secList.className = 'side-section';
    const hList = document.createElement('h3');
    hList.textContent = `Hotspotlar (${state.hotspots.length})`;
    secList.appendChild(hList);

    state.hotspots.forEach(hs => {
      const item = document.createElement('div');
      item.className = 'hotspot-list-item' + (state.selectedIds.has(hs.id) ? ' active' : '');
      item.textContent = buildHotspotLabel(hs);
      item.title = buildHotspotLabel(hs);
      item.addEventListener('click', () => {
        state.selectedIds = new Set([hs.id]);
        state.showSummary = false;
        state.sidePanelVisible = true;
        renderHotspots();
        renderSidePanel();
      });
      secList.appendChild(item);
    });

    sideBody.appendChild(secList);

    const hs = selected[0];
    const secEdit = document.createElement('div');
    secEdit.className = 'side-section';
    const hEdit = document.createElement('h3');
    hEdit.textContent = 'Hotspot detayları';
    secEdit.appendChild(hEdit);

    if (!hs) {
      const p = document.createElement('p');
      p.textContent = 'Düzenlemek için bir hotspot seçin.';
      secEdit.appendChild(p);
      sideBody.appendChild(secEdit);
      return;
    }

    hs.works = createDefaultWorks(hs.works);

    const idp = document.createElement('p');
    idp.textContent = `ID: ${hs.id}`;
    secEdit.appendChild(idp);

    const imgLbl = document.createElement('label');
    imgLbl.textContent = 'Detay görseli';
    secEdit.appendChild(imgLbl);
    if (hs.detailImageUrl) {
      const img = document.createElement('img');
      img.src = hs.detailImageUrl;
      img.className = 'thumb';
      img.addEventListener('click', () => openDetailImageModal(hs.detailImageUrl));
      secEdit.appendChild(img);
    }
    const detailInput = document.createElement('input');
    detailInput.type = 'file';
    detailInput.accept = 'image/*';
    detailInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        hs.detailImageUrl = ev.target.result;
        renderSidePanel();
      };
      reader.readAsDataURL(file);
    });
    secEdit.appendChild(detailInput);

    function makeTextField(labelText, key) {
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = hs[key] || '';
      input.addEventListener('input', () => {
        hs[key] = input.value;
        renderHotspots();
      });
      secEdit.appendChild(label);
      secEdit.appendChild(input);
    }

    makeTextField('Ada', 'ada');
    makeTextField('Parsel', 'parsel');
    makeTextField('Blok', 'blok');

    const labelDesc = document.createElement('label');
    labelDesc.textContent = 'Açıklama';
    const ta = document.createElement('textarea');
    ta.value = hs.description || '';
    ta.addEventListener('input', () => {
      hs.description = ta.value;
    });
    secEdit.appendChild(labelDesc);
    secEdit.appendChild(ta);

    const secWorks = document.createElement('div');
    secWorks.className = 'side-section';
    const hWorks = document.createElement('h3');
    hWorks.textContent = 'İmalat durumları';
    secWorks.appendChild(hWorks);

    WORK_GROUPS.forEach(group => {
      const gh = document.createElement('p');
      gh.style.fontWeight = '600';
      gh.style.fontSize = '12px';
      gh.style.margin = '6px 0 2px 0';
      gh.textContent = group.label;
      secWorks.appendChild(gh);

      group.items.forEach(w => {
        const item = hs.works[w.id] || { status: 'baslamadi', workers: 0, subcontractor: '' };
        hs.works[w.id] = item;

        const row = document.createElement('div');
        row.className = 'works-row';

        const title = document.createElement('div');
        title.className = 'works-row-title';
        title.textContent = w.label;
        row.appendChild(title);

        const controls = document.createElement('div');
        controls.className = 'works-row-controls';

        const select = document.createElement('select');
        STATUS_OPTIONS.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          select.appendChild(o);
        });
        select.value = item.status || 'baslamadi';
        select.addEventListener('change', () => {
          hs.works[w.id].status = select.value;
          renderHotspots();
        });

        const workersInput = document.createElement('input');
        workersInput.type = 'number';
        workersInput.min = '0';
        workersInput.value =
          typeof item.workers === 'number' && !isNaN(item.workers) ? item.workers : 0;
        workersInput.addEventListener('input', () => {
          const val = parseInt(workersInput.value, 10);
          hs.works[w.id].workers = isNaN(val) ? 0 : val;
        });

        const workersLabel = document.createElement('span');
        workersLabel.textContent = 'kişi';

        controls.appendChild(select);
        controls.appendChild(workersInput);
        controls.appendChild(workersLabel);

        row.appendChild(controls);

        const subInput = document.createElement('input');
        subInput.type = 'text';
        subInput.placeholder = 'Alt yüklenici (isteğe bağlı)';
        subInput.value = item.subcontractor || '';
        subInput.addEventListener('input', () => {
          hs.works[w.id].subcontractor = subInput.value;
        });
        row.appendChild(subInput);

        secWorks.appendChild(row);
      });
    });

    secEdit.appendChild(secWorks);

    const styleLabel = document.createElement('h3');
    styleLabel.textContent = 'Stil';
    styleLabel.style.marginTop = '8px';
    secEdit.appendChild(styleLabel);

    const fillColorLabel = document.createElement('label');
    fillColorLabel.textContent = 'Dolgu rengi';
    const fillColorInput = document.createElement('input');
    fillColorInput.type = 'color';
    fillColorInput.value = hs.fillColor || '#2563eb';
    fillColorInput.addEventListener('input', () => {
      hs.fillColor = fillColorInput.value || '#2563eb';
      renderHotspots();
    });
    secEdit.appendChild(fillColorLabel);
    secEdit.appendChild(fillColorInput);

    const fillOpacityLabel = document.createElement('label');
    fillOpacityLabel.textContent = 'Dolgu opaklığı';
    const fillOpacityRow = document.createElement('div');
    fillOpacityRow.className = 'inline-row';
    const fillOpacityInput = document.createElement('input');
    fillOpacityInput.type = 'range';
    fillOpacityInput.min = '0.05';
    fillOpacityInput.max = '1';
    fillOpacityInput.step = '0.05';
    const fOp = typeof hs.fillOpacity === 'number' ? hs.fillOpacity : 0.2;
    fillOpacityInput.value = fOp;
    const fillOpacityText = document.createElement('span');
    fillOpacityText.textContent = Math.round(fOp * 100) + '%';
    fillOpacityInput.addEventListener('input', () => {
      const v = parseFloat(fillOpacityInput.value);
      hs.fillOpacity = isNaN(v) ? 0.2 : v;
      fillOpacityText.textContent = Math.round(hs.fillOpacity * 100) + '%';
      renderHotspots();
    });
    fillOpacityRow.appendChild(fillOpacityInput);
    fillOpacityRow.appendChild(fillOpacityText);
    secEdit.appendChild(fillOpacityLabel);
    secEdit.appendChild(fillOpacityRow);

    const borderColorLabel = document.createElement('label');
    borderColorLabel.textContent = 'Kenarlık rengi';
    const borderColorInput = document.createElement('input');
    borderColorInput.type = 'color';
    borderColorInput.value = hs.borderColor || hs.fillColor || '#60a5fa';
    borderColorInput.addEventListener('input', () => {
      hs.borderColor = borderColorInput.value || hs.fillColor || '#60a5fa';
      renderHotspots();
    });
    secEdit.appendChild(borderColorLabel);
    secEdit.appendChild(borderColorInput);

    const borderOpacityLabel = document.createElement('label');
    borderOpacityLabel.textContent = 'Kenarlık opaklığı';
    const borderOpacityRow = document.createElement('div');
    borderOpacityRow.className = 'inline-row';
    const borderOpacityInput = document.createElement('input');
    borderOpacityInput.type = 'range';
    borderOpacityInput.min = '0';
    borderOpacityInput.max = '1';
    borderOpacityInput.step = '0.05';
    const bOp = typeof hs.borderOpacity === 'number' ? hs.borderOpacity : 1;
    borderOpacityInput.value = bOp;
    const borderOpacityText = document.createElement('span');
    borderOpacityText.textContent = Math.round(bOp * 100) + '%';
    borderOpacityInput.addEventListener('input', () => {
      const v = parseFloat(borderOpacityInput.value);
      hs.borderOpacity = isNaN(v) ? 1 : v;
      borderOpacityText.textContent = Math.round(hs.borderOpacity * 100) + '%';
      renderHotspots();
    });
    borderOpacityRow.appendChild(borderOpacityInput);
    borderOpacityRow.appendChild(borderOpacityText);
    secEdit.appendChild(borderOpacityLabel);
    secEdit.appendChild(borderOpacityRow);

    const hoverLabel = document.createElement('label');
    hoverLabel.textContent = 'Üzerine gelince parlama';
    const hoverRow = document.createElement('div');
    hoverRow.className = 'inline-row';
    const hoverInput = document.createElement('input');
    hoverInput.type = 'checkbox';
    hoverInput.checked = hs.hoverGlow !== false;
    hoverInput.addEventListener('change', () => {
      hs.hoverGlow = hoverInput.checked;
      renderHotspots();
    });
    const hoverText = document.createElement('span');
    hoverText.textContent = 'Hover vurgusu';
    hoverRow.appendChild(hoverInput);
    hoverRow.appendChild(hoverText);
    secEdit.appendChild(hoverLabel);
    secEdit.appendChild(hoverRow);

    const btnRow = document.createElement('div');
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Hotspot sil';
    delBtn.className = 'danger';
    delBtn.addEventListener('click', () => {
      if (!confirm('Seçili hotspot(lar) silinsin mi?')) return;
      const ids = Array.from(state.selectedIds);
      state.hotspots = state.hotspots.filter(hh => !ids.includes(hh.id));
      state.selectedIds.clear();
      state.sidePanelVisible = false;
      renderHotspots();
      renderSidePanel();
    });
    btnRow.appendChild(delBtn);
    secEdit.appendChild(btnRow);

    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = 'Shift+klik: çoklu seçim · İçini sürükle: taşı · Köşeler: yeniden boyutlandır · Klavyede Delete: seçili hotspot sil.';
    secEdit.appendChild(hint);

    sideBody.appendChild(secEdit);
  }

  function updateModeToggleUI() {
    if (!modeToggle) return;
    const viewerBtn = modeToggle.querySelector('button[data-mode="viewer"]');
    const editorBtn = modeToggle.querySelector('button[data-mode="editor"]');
    if (!viewerBtn || !editorBtn) return;
    viewerBtn.classList.toggle('active', state.mode === 'viewer');
    editorBtn.classList.toggle('active', state.mode === 'editor');
  }

  function updateProjectNameLabel() {
    if (!projectNameLabel) return;
    const name = state.projectInfo && state.projectInfo.name
      ? state.projectInfo.name.trim()
      : '';
    if (!name) {
      projectNameLabel.style.display = 'none';
      projectNameLabel.textContent = '';
    } else {
      projectNameLabel.style.display = 'inline-flex';
      projectNameLabel.textContent = name;
    }
  }

  function applyMode(newMode) {
    state.mode = newMode;
    updateModeToggleUI();
    if (mainImageWrapper) {
      mainImageWrapper.style.display = newMode === 'editor' ? 'inline-flex' : 'none';
    }
    if (addHotspotBtn) {
      addHotspotBtn.style.display = newMode === 'editor' ? 'inline-flex' : 'none';
    }
    if (passwordSettingsBtn) {
      passwordSettingsBtn.style.display = newMode === 'editor' ? 'inline-flex' : 'none';
    }
    if (projectInfoBtn) {
      projectInfoBtn.style.display = newMode === 'editor' ? 'inline-flex' : 'none';
    }
    renderHotspots();
    renderSidePanel();
  }

  function dataUrlToParts(dataUrl) {
    const parts = String(dataUrl).split(',');
    if (parts.length !== 2) {
      return { mime: 'application/octet-stream', base64: '' };
    }
    const header = parts[0];
    const data = parts[1];
    const m = header.match(/^data:(.*?);base64$/);
    const mime = m ? m[1] : 'application/octet-stream';
    return { mime, base64: data };
  }

  function mimeToExt(mime) {
    if (!mime) return '.bin';
    if (mime === 'image/png') return '.png';
    if (mime === 'image/jpeg' || mime === 'image/jpg') return '.jpg';
    if (mime === 'image/webp') return '.webp';
    return '.bin';
  }

  function sanitizeFilename(str) {
    return String(str || '')
      .toLowerCase()
      .replace(/[^a-z0-9\-]+/g, '_')
      .replace(/^_+|_+$/g, '') || 'item';
  }

  function formatDateTime(date) {
    const d = new Date(date);
    if (isNaN(d.getTime())) return '';
    const pad = n => String(n).padStart(2, '0');
    return d.getFullYear() + '-' +
      pad(d.getMonth() + 1) + '-' +
      pad(d.getDate()) + ' ' +
      pad(d.getHours()) + ':' +
      pad(d.getMinutes()) + ':' +
      pad(d.getSeconds());
  }

  function updateLastExportLabel() {
    if (!lastExportLabel) return;
    if (!state.lastExportAt) {
      lastExportLabel.textContent = 'Son kayıt: -';
    } else {
      lastExportLabel.textContent = 'Son kayıt: ' + formatDateTime(state.lastExportAt);
    }
  }

  function readPin(container) {
    if (!container) return '';
    const inputs = container.querySelectorAll('.pin-box');
    let pin = '';
    inputs.forEach(input => {
      const v = (input.value || '').replace(/\D/g, '');
      if (v) pin += v.charAt(0);
    });
    return pin;
  }

  function setPin(container, pin) {
    if (!container) return;
    const inputs = container.querySelectorAll('.pin-box');
    for (let i = 0; i < inputs.length; i++) {
      inputs[i].value = pin && pin[i] ? pin[i] : '';
    }
  }

  function clearPin(container) {
    setPin(container, '');
  }

  function focusFirstPin(container) {
    if (!container) return;
    const first = container.querySelector('.pin-box');
    if (first) first.focus();
  }

  function setupPinAutoAdvance(container) {
    if (!container) return;
    const inputs = Array.from(container.querySelectorAll('.pin-box'));
    inputs.forEach((input, idx) => {
      input.addEventListener('input', () => {
        let v = (input.value || '').replace(/\D/g, '');
        if (v.length > 1) v = v.charAt(0);
        input.value = v;
        if (v && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }
      });
      input.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !input.value && idx > 0) {
          inputs[idx - 1].focus();
        }
        if (e.key === 'ArrowLeft' && idx > 0) {
          e.preventDefault();
          inputs[idx - 1].focus();
        }
        if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
          e.preventDefault();
          inputs[idx + 1].focus();
        }
      });
    });
  }

  setupPinAutoAdvance(passwordSettingsPin);
  setupPinAutoAdvance(passwordPromptPin);

  let pendingModeAfterPassword = null;

  function openPasswordPrompt() {
    if (!passwordPromptOverlay || !passwordPromptPin) {
      const entered = window.prompt("Düzenleme PIN'ini girin:") || '';
      if (entered === state.editorPassword) {
        state.editorUnlocked = true;
        if (pendingModeAfterPassword) {
          applyMode(pendingModeAfterPassword);
          pendingModeAfterPassword = null;
        }
      } else if (entered !== null) {
        alert('PIN hatalı.');
        pendingModeAfterPassword = null;
      }
      return;
    }
    clearPin(passwordPromptPin);
    passwordPromptOverlay.style.display = 'flex';
    setTimeout(() => focusFirstPin(passwordPromptPin), 10);
  }

  if (modeToggle) {
    modeToggle.addEventListener('click', e => {
      const btn = e.target.closest('button[data-mode]');
      if (!btn) return;
      const targetMode = btn.dataset.mode;
      if (!targetMode || targetMode === state.mode) return;

      if (targetMode === 'viewer') {
        applyMode('viewer');
        return;
      }

      if (targetMode === 'editor') {
        if (state.editorPassword && !state.editorUnlocked) {
          pendingModeAfterPassword = 'editor';
          openPasswordPrompt();
        } else {
          applyMode('editor');
        }
      }
    });
  }

  panModeBtn.addEventListener('click', () => {
    state.panMode = !state.panMode;
    panModeBtn.classList.toggle('toggle-active', state.panMode);
  });

  labelsBtn.addEventListener('click', () => {
    state.showLabels = !state.showLabels;
    labelsBtn.classList.toggle('toggle-active', state.showLabels);
    renderHotspots();
  });

  summaryBtn.addEventListener('click', () => {
    state.showSummary = !state.showSummary;
    summaryBtn.classList.toggle('toggle-active', state.showSummary);
    if (state.showSummary) {
      state.selectedIds.clear();
      state.sidePanelVisible = true;
    }
    renderSidePanel();
  });

  if (aboutBtn && aboutOverlay) {
    aboutBtn.addEventListener('click', () => {
      aboutOverlay.style.display = 'flex';
    });
    aboutOverlay.addEventListener('click', e => {
      if (e.target === aboutOverlay) {
        aboutOverlay.style.display = 'none';
      }
    });
  }

  if (detailImageOverlay && detailImageLarge) {
    detailImageOverlay.addEventListener('click', e => {
      if (e.target === detailImageOverlay) {
        detailImageOverlay.style.display = 'none';
        detailImageLarge.src = '';
      }
    });
  }

  if (passwordSettingsBtn && passwordSettingsOverlay) {
    passwordSettingsBtn.addEventListener('click', () => {
      if (state.mode !== 'editor') return;
      if (passwordSettingsPin) {
        if (state.editorPassword) {
          setPin(passwordSettingsPin, state.editorPassword);
        } else {
          clearPin(passwordSettingsPin);
        }
      }
      passwordSettingsOverlay.style.display = 'flex';
      setTimeout(() => focusFirstPin(passwordSettingsPin), 10);
    });

    passwordSettingsCancel.addEventListener('click', () => {
      passwordSettingsOverlay.style.display = 'none';
    });

    passwordSettingsOverlay.addEventListener('click', e => {
      if (e.target === passwordSettingsOverlay) {
        passwordSettingsOverlay.style.display = 'none';
      }
    });

    passwordSettingsSave.addEventListener('click', () => {
      const newPin = readPin(passwordSettingsPin);
      if (newPin && newPin.length === 4) {
        state.editorPassword = newPin;
        state.editorUnlocked = false;
        alert("Düzenleme PIN'i ayarlandı.");
      } else {
        state.editorPassword = '';
        state.editorUnlocked = true;
        alert("Düzenleme PIN'i kaldırıldı.");
      }
      passwordSettingsOverlay.style.display = 'none';
    });
  }

  if (passwordPromptOverlay && passwordPromptPin) {
    passwordPromptCancel.addEventListener('click', () => {
      passwordPromptOverlay.style.display = 'none';
      pendingModeAfterPassword = null;
      applyMode('viewer');
    });

    passwordPromptOverlay.addEventListener('click', e => {
      if (e.target === passwordPromptOverlay) {
        passwordPromptOverlay.style.display = 'none';
        pendingModeAfterPassword = null;
        applyMode('viewer');
      }
    });

    passwordPromptOk.addEventListener('click', () => {
      const entered = readPin(passwordPromptPin);
      if (entered === state.editorPassword) {
        state.editorUnlocked = true;
        passwordPromptOverlay.style.display = 'none';
        if (pendingModeAfterPassword) {
          applyMode(pendingModeAfterPassword);
          pendingModeAfterPassword = null;
        }
      } else {
        alert('PIN hatalı.');
        clearPin(passwordPromptPin);
        focusFirstPin(passwordPromptPin);
      }
    });
  }

  if (projectInfoBtn && projectInfoOverlay) {
    projectInfoBtn.addEventListener('click', () => {
      if (state.mode !== 'editor') return;
      const info = state.projectInfo || { name: '', contractor: '' };
      if (projectNameInput) projectNameInput.value = info.name || '';
      if (projectContractorInput) projectContractorInput.value = info.contractor || '';
      projectInfoOverlay.style.display = 'flex';
      setTimeout(() => {
        if (projectNameInput) projectNameInput.focus();
      }, 10);
    });

    projectInfoCancel.addEventListener('click', () => {
      projectInfoOverlay.style.display = 'none';
    });

    projectInfoOverlay.addEventListener('click', e => {
      if (e.target === projectInfoOverlay) {
        projectInfoOverlay.style.display = 'none';
      }
    });

    projectInfoSave.addEventListener('click', () => {
      const name = projectNameInput ? projectNameInput.value.trim() : '';
      const contractor = projectContractorInput ? projectContractorInput.value.trim() : '';
      state.projectInfo = { name, contractor };
      updateProjectNameLabel();
      projectInfoOverlay.style.display = 'none';
    });
  }

  if (workViewSelect) {
    workViewSelect.innerHTML = '';
    const optDefault = document.createElement('option');
    optDefault.value = '';
    optDefault.textContent = 'Orijinal görünüm';
    workViewSelect.appendChild(optDefault);

    WORK_GROUPS.forEach(group => {
      const og = document.createElement('optgroup');
      og.label = group.label;
      group.items.forEach(item => {
        const o = document.createElement('option');
        o.value = item.id;
        o.textContent = item.label;
        og.appendChild(o);
      });
      workViewSelect.appendChild(og);
    });

    workViewSelect.addEventListener('change', () => {
      const val = workViewSelect.value || '';
      state.highlightWorkTypeId = val === '' ? null : val;
      state.showSummary = false;
      renderHotspots();
    });
  }

  mainImageInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      state.mainImageUrl = ev.target.result;
      mainImage.src = state.mainImageUrl;
      mainImage.onload = () => {
        setTransform();
        renderHotspots();
        renderSidePanel();
      };
    };
    reader.readAsDataURL(file);
  });

  resetViewBtn.addEventListener('click', () => {
    state.scale = 1;
    state.offsetX = 0;
    state.offsetY = 0;
    setTransform();
  });

  addHotspotBtn.addEventListener('click', () => {
    if (!state.mainImageUrl) {
      alert('Önce bir ana görsel yükleyin.');
      return;
    }
    createHotspot();
  });

  exportBtn.addEventListener('click', async () => {
    if (!state.mainImageUrl) {
      alert('Dışa aktarılacak ana görsel yok.');
      return;
    }
    if (typeof JSZip === 'undefined') {
      alert('JSZip yüklenemedi.');
      return;
    }

    const zip = new JSZip();
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    const fileName = 'site-plan-' +
      now.getFullYear() +
      pad(now.getMonth() + 1) +
      pad(now.getDate()) + '-' +
      pad(now.getHours()) +
      pad(now.getMinutes()) +
      pad(now.getSeconds()) +
      '.epp';

    const cfg = {
      version: 8,
      grid: state.grid,
      mainImage: null,
      hotspots: [],
      exportedAt: now.toISOString(),
      editorPassword: state.editorPassword || '',
      projectInfo: state.projectInfo || null
    };

    const mainParts = dataUrlToParts(state.mainImageUrl);
    if (!mainParts.base64) {
      alert('Ana görsel verisi geçersiz.');
      return;
    }
    const mainExt = mimeToExt(mainParts.mime);
    const mainPath = 'images/main' + mainExt;
    cfg.mainImage = { path: mainPath, mime: mainParts.mime };
    zip.file(mainPath, mainParts.base64, { base64: true });

    state.hotspots.forEach((hs, idx) => {
      let detail = null;
      if (hs.detailImageUrl) {
        const detParts = dataUrlToParts(hs.detailImageUrl);
        if (detParts.base64) {
          const detExt = mimeToExt(detParts.mime);
          const safeId = sanitizeFilename(hs.id);
          const detPath = `images/detail-${idx + 1}-${safeId}${detExt}`;
          zip.file(detPath, detParts.base64, { base64: true });
          detail = { path: detPath, mime: detParts.mime };
        }
      }
      const worksClean = {};
      const srcWorks = hs.works || {};
      ALL_WORK_ITEMS.forEach(w => {
        const item = srcWorks[w.id] || { status: 'baslamadi', workers: 0, subcontractor: '' };
        worksClean[w.id] = {
          status: item.status || 'baslamadi',
          workers: typeof item.workers === 'number' ? item.workers : 0,
          subcontractor: typeof item.subcontractor === 'string' ? item.subcontractor : ''
        };
      });

      cfg.hotspots.push({
        id: hs.id,
        top: hs.top,
        left: hs.left,
        width: hs.width,
        height: hs.height,
        ada: hs.ada || '',
        parsel: hs.parsel || '',
        blok: hs.blok || '',
        description: hs.description || '',
        detailImage: detail,
        fillColor: hs.fillColor || '#2563eb',
        fillOpacity: typeof hs.fillOpacity === 'number' ? hs.fillOpacity : 0.2,
        borderColor: hs.borderColor || hs.fillColor || '#60a5fa',
        borderOpacity: typeof hs.borderOpacity === 'number' ? hs.borderOpacity : 1,
        hoverGlow: hs.hoverGlow !== false,
        works: worksClean
      });
    });

    zip.file('config.json', JSON.stringify(cfg, null, 2));

    try {
      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      state.lastExportAt = now;
      updateLastExportLabel();
    } catch (err) {
      console.error(err);
      alert('EPP oluşturulurken hata oluştu.');
    }
  });

  importBtn.addEventListener('click', () => {
    importInput.value = '';
    importInput.click();
  });

  importInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async ev => {
      try {
        if (typeof JSZip === 'undefined') {
          alert('JSZip yüklenemedi.');
          return;
        }
        const zip = await JSZip.loadAsync(ev.target.result);
        const cfgFile = zip.file('config.json');
        if (!cfgFile) {
          alert('EPP içinde config.json bulunamadı.');
          return;
        }
        const cfgText = await cfgFile.async('string');
        const cfg = JSON.parse(cfgText);

        if (!cfg.mainImage || !cfg.mainImage.path) {
          alert('Geçersiz konfigürasyon: Ana görsel tanımı yok.');
          return;
        }

        const mainZipFile = zip.file(cfg.mainImage.path);
        if (!mainZipFile) {
          alert('EPP içinde ana görsel dosyası bulunamadı.');
          return;
        }
        const mainBase64 = await mainZipFile.async('base64');
        const mainMime = cfg.mainImage.mime || 'image/png';
        state.mainImageUrl = `data:${mainMime};base64,${mainBase64}`;

        state.grid = cfg.grid || 1;

        state.editorPassword = typeof cfg.editorPassword === 'string' ? cfg.editorPassword : '';
        state.editorUnlocked = !state.editorPassword;

        state.projectInfo = cfg.projectInfo || { name: '', contractor: '' };
        updateProjectNameLabel();

        if (cfg.exportedAt) {
          const dt = new Date(cfg.exportedAt);
          if (!isNaN(dt.getTime())) {
            state.lastExportAt = dt;
          }
        }
        updateLastExportLabel();

        const hotspotDefs = Array.isArray(cfg.hotspots) ? cfg.hotspots : [];
        const hotspotPromises = hotspotDefs.map(async h => {
          let detailUrl = null;
          if (h.detailImage && h.detailImage.path) {
            const detFile = zip.file(h.detailImage.path);
            if (detFile) {
              const detBase64 = await detFile.async('base64');
              const detMime = h.detailImage.mime || 'image/png';
              detailUrl = `data:${detMime};base64,${detBase64}`;
            }
          }

          const fillColor = h.fillColor || h.color || '#2563eb';
          const fillOpacity = typeof h.fillOpacity === 'number'
            ? h.fillOpacity
            : (typeof h.opacity === 'number' ? h.opacity : 0.2);
          const borderColor = h.borderColor || fillColor || '#60a5fa';
          const borderOpacity = typeof h.borderOpacity === 'number' ? h.borderOpacity : 1;

          const works = createDefaultWorks(h.works);

          return {
            id: h.id,
            top: h.top,
            left: h.left,
            width: h.width,
            height: h.height,
            ada: h.ada || '',
            parsel: h.parsel || '',
            blok: h.blok || '',
            description: h.description || '',
            detailImageUrl: detailUrl,
            fillColor,
            fillOpacity,
            borderColor,
            borderOpacity,
            hoverGlow: h.hoverGlow !== false,
            works
          };
        });

        const newHotspots = await Promise.all(hotspotPromises);
        state.hotspots = newHotspots;
        state.selectedIds = new Set();
        state.showSummary = false;
        state.sidePanelVisible = false;
        state.highlightWorkTypeId = null;

        mainImage.src = state.mainImageUrl;
        mainImage.onload = () => {
          state.scale = 1;
          state.offsetX = 0;
          state.offsetY = 0;
          setTransform();
          renderHotspots();
          renderSidePanel();
        };

        applyMode('viewer');
      } catch (err) {
        console.error(err);
        alert('EPP okunurken hata oluştu.');
      }
    };
    reader.readAsArrayBuffer(file);
  });

  canvasWrapper.addEventListener('wheel', e => {
    if (!e.ctrlKey) return;
    e.preventDefault();
    const rect = canvasWrapper.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const oldScale = state.scale;
    const factor = e.deltaY < 0 ? 1.1 : 0.9;
    const newScale = Math.min(5, Math.max(0.25, oldScale * factor));

    const contentX = (mx - state.offsetX) / oldScale;
    const contentY = (my - state.offsetY) / oldScale;

    state.offsetX = mx - contentX * newScale;
    state.offsetY = my - contentY * newScale;
    state.scale = newScale;
    setTransform();
  }, { passive: false });

  let panState = null;
  canvasWrapper.addEventListener('mousedown', e => {
    if (e.button === 1 || (e.button === 0 && state.panMode)) {
      e.preventDefault();
      panState = {
        startX: e.clientX,
        startY: e.clientY,
        offsetX: state.offsetX,
        offsetY: state.offsetY
      };
    }
  });
  document.addEventListener('mousemove', e => {
    if (!panState) return;
    const dx = e.clientX - panState.startX;
    const dy = e.clientY - panState.startY;
    state.offsetX = panState.offsetX + dx;
    state.offsetY = panState.offsetY + dy;
    setTransform();
  });
  document.addEventListener('mouseup', () => {
    panState = null;
  });

  let dragState = null;
  let drawState = null;

  hotspotLayer.addEventListener('mousedown', e => {
    if (state.panMode && e.button === 0) {
      return;
    }

    if (state.mode !== 'editor') {
      const hotspotEl = e.target.closest('.hotspot');
      if (!hotspotEl) return;
      const id = hotspotEl.dataset.id;
      state.selectedIds = new Set([id]);
      state.showSummary = false;
      state.sidePanelVisible = true;
      renderHotspots();
      renderSidePanel();
      return;
    }

    const handleEl = e.target.closest('.handle');
    const hotspotEl = e.target.closest('.hotspot');

    if (!hotspotEl && !handleEl && e.target === hotspotLayer) {
      if (!state.mainImageUrl) return;
      const imgRect = mainImage.getBoundingClientRect();
      if (imgRect.width === 0 || imgRect.height === 0) return;

      drawState = {
        startX: e.clientX,
        startY: e.clientY,
        imgRect,
        ghostEl: null
      };
      e.preventDefault();
      return;
    }

    if (!hotspotEl) return;

    const id = hotspotEl.dataset.id;
    const hs = getHotspot(id);
    const imgRect = mainImage.getBoundingClientRect();
    const startX = e.clientX;
    const startY = e.clientY;

    if (e.shiftKey) {
      if (state.selectedIds.has(id)) state.selectedIds.delete(id);
      else state.selectedIds.add(id);
    } else {
      state.selectedIds = new Set([id]);
    }
    state.showSummary = false;
    state.sidePanelVisible = true;
    renderHotspots();
    renderSidePanel();

    if (handleEl) {
      const handlePos = handleEl.dataset.handle || 'se';
      const topPct = hs.top;
      const leftPct = hs.left;
      const bottomPct = hs.top + hs.height;
      const rightPct = hs.left + hs.width;

      let anchorLeftPct, anchorTopPct;
      if (handlePos === 'se') {
        anchorLeftPct = leftPct;
        anchorTopPct = topPct;
      } else if (handlePos === 'nw') {
        anchorLeftPct = rightPct;
        anchorTopPct = bottomPct;
      } else if (handlePos === 'ne') {
        anchorLeftPct = leftPct;
        anchorTopPct = bottomPct;
      } else if (handlePos === 'sw') {
        anchorLeftPct = rightPct;
        anchorTopPct = topPct;
      } else {
        anchorLeftPct = leftPct;
        anchorTopPct = topPct;
      }

      dragState = {
        type: 'resize',
        id,
        handle: handlePos,
        imgRect,
        anchorLeftPct,
        anchorTopPct
      };
    } else {
      const selectedIds = Array.from(state.selectedIds);
      dragState = {
        type: 'move',
        ids: selectedIds,
        startX,
        startY,
        imgRect,
        startPositions: selectedIds.map(hid => {
          const h = getHotspot(hid);
          return { id: hid, top: h.top, left: h.left };
        })
      };
    }
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (dragState) {
      const { imgRect } = dragState;
      if (imgRect.width === 0 || imgRect.height === 0) return;

      if (dragState.type === 'move') {
        const dxPx = e.clientX - dragState.startX;
        const dyPx = e.clientY - dragState.startY;
        const dxPct = dxPx * 100 / imgRect.width;
        const dyPct = dyPx * 100 / imgRect.height;

        dragState.startPositions.forEach(sp => {
          const hs = getHotspot(sp.id);
          if (!hs) return;
          let newTop = sp.top + dyPct;
          let newLeft = sp.left + dxPct;
          newTop = Math.max(0, Math.min(100 - hs.height, newTop));
          newLeft = Math.max(0, Math.min(100 - hs.width, newLeft));
          hs.top = newTop;
          hs.left = newLeft;
        });

        renderHotspots();
        return;
      }

      if (dragState.type === 'resize') {
        const hs = getHotspot(dragState.id);
        if (!hs) return;
        const { imgRect, handle, anchorLeftPct, anchorTopPct } = dragState;

        if (imgRect.width === 0 || imgRect.height === 0) return;

        const MIN_PX = 8;
        const minPctX = (MIN_PX * 100) / imgRect.width;
        const minPctY = (MIN_PX * 100) / imgRect.height;

        let pointerLeftPct = ((e.clientX - imgRect.left) * 100) / imgRect.width;
        let pointerTopPct = ((e.clientY - imgRect.top) * 100) / imgRect.height;

        pointerLeftPct = Math.max(0, Math.min(100, pointerLeftPct));
        pointerTopPct = Math.max(0, Math.min(100, pointerTopPct));

        let newLeft, newTop, newWidth, newHeight;

        if (handle === 'se') {
          pointerLeftPct = Math.max(anchorLeftPct + minPctX, pointerLeftPct);
          pointerTopPct = Math.max(anchorTopPct + minPctY, pointerTopPct);

          newLeft = anchorLeftPct;
          newTop = anchorTopPct;
          newWidth = pointerLeftPct - anchorLeftPct;
          newHeight = pointerTopPct - anchorTopPct;
        } else if (handle === 'nw') {
          pointerLeftPct = Math.min(anchorLeftPct - minPctX, pointerLeftPct);
          pointerTopPct = Math.min(anchorTopPct - minPctY, pointerTopPct);

          newLeft = pointerLeftPct;
          newTop = pointerTopPct;
          newWidth = anchorLeftPct - newLeft;
          newHeight = anchorTopPct - newTop;
        } else if (handle === 'ne') {
          pointerLeftPct = Math.max(anchorLeftPct + minPctX, pointerLeftPct);
          pointerTopPct = Math.min(anchorTopPct - minPctY, pointerTopPct);

          newLeft = anchorLeftPct;
          newTop = pointerTopPct;
          newWidth = pointerLeftPct - anchorLeftPct;
          newHeight = anchorTopPct - newTop;
        } else if (handle === 'sw') {
          pointerLeftPct = Math.min(anchorLeftPct - minPctX, pointerLeftPct);
          pointerTopPct = Math.max(anchorTopPct + minPctY, pointerTopPct);

          newLeft = pointerLeftPct;
          newTop = anchorTopPct;
          newWidth = anchorLeftPct - newLeft;
          newHeight = pointerTopPct - anchorTopPct;
        } else {
          return;
        }

        if (newLeft < 0) {
          newWidth -= (0 - newLeft);
          newLeft = 0;
        }
        if (newTop < 0) {
          newHeight -= (0 - newTop);
          newTop = 0;
        }
        if (newLeft + newWidth > 100) {
          newWidth = 100 - newLeft;
        }
        if (newTop + newHeight > 100) {
          newHeight = 100 - newTop;
        }

        newWidth = Math.max(minPctX, newWidth);
        newHeight = Math.max(minPctY, newHeight);

        hs.left = newLeft;
        hs.top = newTop;
        hs.width = newWidth;
        hs.height = newHeight;

        renderHotspots();
        return;
      }
    }

    if (drawState) {
      const { imgRect } = drawState;
      if (imgRect.width === 0 || imgRect.height === 0) return;
      const x1 = drawState.startX;
      const y1 = drawState.startY;
      const x2 = e.clientX;
      const y2 = e.clientY;

      const leftPx = Math.min(x1, x2);
      const topPx = Math.min(y1, y2);
      const widthPx = Math.abs(x2 - x1);
      const heightPx = Math.abs(y2 - y1);

      const relLeft = ((leftPx - imgRect.left) * 100) / imgRect.width;
      const relTop = ((topPx - imgRect.top) * 100) / imgRect.height;
      const relWidth = (widthPx * 100) / imgRect.width;
      const relHeight = (heightPx * 100) / imgRect.height;

      if (!drawState.ghostEl) {
        const el = document.createElement('div');
        el.className = 'hotspot';
        el.style.pointerEvents = 'none';
        hotspotLayer.appendChild(el);
        drawState.ghostEl = el;
      }

      const el = drawState.ghostEl;
      el.style.top = relTop + '%';
      el.style.left = relLeft + '%';
      el.style.width = relWidth + '%';
      el.style.height = relHeight + '%';
    }
  });

  document.addEventListener('mouseup', e => {
    if (dragState) {
      dragState.ids = dragState.ids || (dragState.id ? [dragState.id] : []);
      dragState.ids.forEach(id => {
        const hs = getHotspot(id);
        if (!hs) return;
        hs.top = snapPercent(hs.top);
        hs.left = snapPercent(hs.left);
        hs.width = snapPercent(hs.width);
        hs.height = snapPercent(hs.height);
        hs.top = Math.max(0, Math.min(100 - hs.height, hs.top));
        hs.left = Math.max(0, Math.min(100 - hs.width, hs.left));
      });
      dragState = null;
      renderHotspots();
      return;
    }

    if (drawState) {
      const { imgRect } = drawState;
      if (imgRect.width === 0 || imgRect.height === 0) {
        if (drawState.ghostEl) drawState.ghostEl.remove();
        drawState = null;
        return;
      }
      const x1 = drawState.startX;
      const y1 = drawState.startY;
      const x2 = e.clientX;
      const y2 = e.clientY;
      const widthPx = Math.abs(x2 - x1);
      const heightPx = Math.abs(y2 - y1);

      if (drawState.ghostEl) {
        drawState.ghostEl.remove();
      }
      drawState = null;

      if (widthPx < 10 || heightPx < 10) {
        return;
      }

      const leftPx = Math.min(x1, x2);
      const topPx = Math.min(y1, y2);
      const relLeft = ((leftPx - imgRect.left) * 100) / imgRect.width;
      const relTop = ((topPx - imgRect.top) * 100) / imgRect.height;
      const relWidth = (widthPx * 100) / imgRect.width;
      const relHeight = (heightPx * 100) / imgRect.height;

      createHotspot({
        top: snapPercent(relTop),
        left: snapPercent(relLeft),
        width: snapPercent(relWidth),
        height: snapPercent(relHeight)
      });
    }
  });

  canvasWrapper.addEventListener('click', e => {
    const hotspotEl = e.target.closest('.hotspot');
    if (!hotspotEl) {
      state.selectedIds.clear();
      state.showSummary = false;
      state.sidePanelVisible = false;
      renderHotspots();
      renderSidePanel();
    }
  });

  document.addEventListener('keydown', e => {
    if (state.mode !== 'editor') return;
    if (e.key !== 'Delete') return;

    const active = document.activeElement;
    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT')) {
      return;
    }

    if (!state.selectedIds.size) return;
    e.preventDefault();

    const ids = Array.from(state.selectedIds);
    state.hotspots = state.hotspots.filter(h => !ids.includes(h.id));
    state.selectedIds.clear();
    state.sidePanelVisible = false;
    renderHotspots();
    renderSidePanel();
  });

  setTransform();
  updateLastExportLabel();
  updateProjectNameLabel();
  state.sidePanelVisible = false;
  renderHotspots();
  renderSidePanel();
  applyMode('viewer');
})();
</script>
</body>
</html>

